<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediBot - Medical Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Smooth transitions */
        * {
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        
        /* Message animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .message-animate {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Loading dots */
        @keyframes dot-flashing {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        .loading-dot {
            animation: dot-flashing 1.4s infinite;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Listening indicator animation */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        .listening-indicator {
            position: relative;
        }
        .listening-indicator::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.3);
            animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Doctor avatar container */
        .doctor-avatar-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="h-full overflow-hidden bg-gray-50 dark:bg-gray-900">
    <div class="flex h-full" id="app">
        <!-- Left Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col hidden md:flex">
            <!-- User Profile Section -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center space-x-3 mb-4">
                    {% if user.profile_pic %}
                    <img src="{{ user.profile_pic }}" alt="{{ user.name }}" class="w-10 h-10 rounded-full border-2 border-gray-300 dark:border-gray-600">
                    {% else %}
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg">
                        {{ user.name[0].upper() if user.name else 'U' }}
                    </div>
                    {% endif %}
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">{{ user.name }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ user.email }}</p>
                    </div>
                </div>
                <button onclick="toggleTheme()" class="w-full px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                    <span class="theme-text">Dark Mode</span>
                </button>
            </div>
            
            <!-- New Chat Button -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <button onclick="createNewChat()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>New Chat</span>
                </button>
            </div>
            
            <!-- Chat History -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2" id="chatHistory">
                <div class="space-y-1" id="chatHistoryList">
                    <!-- Chat sessions will be loaded here -->
                </div>
            </div>
            
            <!-- Logout Button -->
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('logout') }}" class="w-full px-4 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </aside>
        
        <!-- Mobile Sidebar -->
        <aside id="mobileSidebar" class="md:hidden fixed inset-y-0 left-0 w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
            <!-- Mobile Sidebar Content (same as desktop) -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Menu</h2>
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        <i class="fas fa-times text-gray-700 dark:text-gray-300"></i>
                    </button>
                </div>
                <div class="flex items-center space-x-3 mb-4">
                    {% if user.profile_pic %}
                    <img src="{{ user.profile_pic }}" alt="{{ user.name }}" class="w-10 h-10 rounded-full border-2 border-gray-300 dark:border-gray-600">
                    {% else %}
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg">
                        {{ user.name[0].upper() if user.name else 'U' }}
                    </div>
                    {% endif %}
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">{{ user.name }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ user.email }}</p>
                    </div>
                </div>
                <button onclick="toggleTheme()" class="w-full px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                    <span class="theme-text">Dark Mode</span>
                </button>
            </div>
            
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <button onclick="createNewChat()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>New Chat</span>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2" id="mobileChatHistory">
                <div class="space-y-1" id="mobileChatHistoryList">
                    <!-- Chat sessions will be loaded here -->
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('logout') }}" class="w-full px-4 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </aside>
        
        <!-- Mobile Sidebar Overlay -->
        <div id="mobileOverlay" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>
        
        <!-- Mobile Sidebar Toggle Button -->
        <button onclick="toggleSidebar()" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <i class="fas fa-bars text-gray-700 dark:text-gray-300"></i>
        </button>
        
        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col h-full relative">
            <!-- Chat Header -->
            <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" alt="MediBot" class="w-8 h-8 rounded-full">
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900 dark:text-white">MediBot</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Medical Assistant</p>
                    </div>
                </div>
                <!-- Text-to-Speech Toggle Button -->
                <button 
                    id="ttsToggle" 
                    class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                    title="Toggle Text-to-Speech"
                >
                    <i class="fas fa-volume-up text-gray-700 dark:text-gray-300" id="ttsIcon"></i>
                </button>
            </header>
            
            <!-- Doctor Avatar Animation -->
            <div class="doctor-avatar-container bg-white dark:bg-gray-800">
                <lottie-player 
                    id="doctorAvatar"
                    src="{{ url_for('static', filename='doctor-animation.json') }}" 
                    background="transparent" 
                    speed="1" 
                    style="width: 150px; height: 150px;" 
                    loop 
                    autoplay
                ></lottie-player>
            </div>
            
            <!-- Messages Container -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4" id="messagesContainer">
                <div class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400" id="welcomeMessage">
                    <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" alt="MediBot" class="w-16 h-16 mb-4 opacity-50">
                    <h2 class="text-xl font-semibold mb-2">Welcome to MediBot</h2>
                    <p class="text-center max-w-md">Ask me anything about medical topics. I'm here to help!</p>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
                <form id="chatForm" class="flex items-end space-x-2 max-w-4xl mx-auto">
                    <div class="flex-1 relative">
                        <textarea 
                            id="messageInput" 
                            rows="1" 
                            placeholder="Type your message..." 
                            class="w-full px-4 py-3 pr-20 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none custom-scrollbar"
                            style="max-height: 120px;"
                        ></textarea>
                        <!-- Microphone Button -->
                        <button 
                            type="button"
                            id="micButton"
                            class="absolute right-3 bottom-3 p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                            title="Voice Input"
                        >
                            <i class="fas fa-microphone" id="micIcon"></i>
                        </button>
                        <!-- Listening Indicator -->
                        <div id="listeningIndicator" class="hidden absolute right-3 bottom-3">
                            <div class="listening-indicator w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                                <div class="w-3 h-3 bg-white rounded-full"></div>
                            </div>
                            <span class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs text-red-600 dark:text-red-400 font-medium whitespace-nowrap">Listening...</span>
                        </div>
                    </div>
                    <button 
                        type="submit" 
                        id="sendButton"
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                        disabled
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </main>
    </div>
    
    <script>
        // Global state
        let currentSessionId = null;
        let isLoading = false;
        let isLoadingHistory = false; // Flag to prevent TTS during history loading
        let chatSessions = {{ chat_sessions | tojson | safe }};
        let ttsEnabled = true; // Text-to-Speech enabled by default
        let currentUtterance = null; // Track current speech synthesis
        let recognition = null;
        let isListening = false;
        
        // Theme management
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark', theme === 'dark');
            updateThemeButton();
        }
        
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeButton();
        }
        
        function updateThemeButton() {
            const isDark = document.documentElement.classList.contains('dark');
            const themeTexts = document.querySelectorAll('.theme-text');
            themeTexts.forEach(themeText => {
            if (themeText) {
                themeText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            }
            });
        }
        
        // Sidebar management
        function toggleSidebar() {
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.getElementById('mobileOverlay');
            const isHidden = sidebar.classList.contains('-translate-x-full');
            
            if (isHidden) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
        
        // Chat session management
        function createNewChat() {
            currentSessionId = null;
            document.getElementById('messagesContainer').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400">
                    <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" alt="MediBot" class="w-16 h-16 mb-4 opacity-50">
                    <h2 class="text-xl font-semibold mb-2">New Chat</h2>
                    <p class="text-center max-w-md">Start a new conversation with MediBot</p>
                </div>
            `;
            updateActiveChat(null);
            toggleSidebar();
        }
        
        async function loadChatSession(sessionId) {
            try {
                isLoading = true;
                isLoadingHistory = true; // Prevent TTS during history loading
                const response = await fetch(`/api/chat/session/${sessionId}/load`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load session');
                
                const data = await response.json();
                currentSessionId = sessionId;
                
                // Clear messages
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                // Load messages
                if (data.chats && data.chats.length > 0) {
                    data.chats.forEach(chat => {
                        addMessage(chat.message, 'user', new Date(chat.timestamp));
                        addMessage(chat.response, 'assistant', new Date(chat.timestamp));
                    });
                    scrollToBottom();
                } else {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400">
                            <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" alt="MediBot" class="w-16 h-16 mb-4 opacity-50">
                            <h2 class="text-xl font-semibold mb-2">Chat Session</h2>
                            <p class="text-center max-w-md">Continue your conversation</p>
                        </div>
                    `;
                }
                
                updateActiveChat(sessionId);
                toggleSidebar();
            } catch (error) {
                console.error('Error loading session:', error);
                alert('Failed to load chat session');
            } finally {
                isLoading = false;
                isLoadingHistory = false; // Re-enable TTS after loading
            }
        }
        
        async function deleteChatSession(sessionId, event) {
            event.stopPropagation();
            if (!confirm('Are you sure you want to delete this chat?')) return;
            
            try {
                const response = await fetch(`/api/chat/session/${sessionId}/delete`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete session');
                
                // Remove from UI
                document.getElementById(`session-${sessionId}`).remove();
                
                // If deleted session was active, create new chat
                if (currentSessionId === sessionId) {
                    createNewChat();
                }
                
                // Reload sessions
                await loadChatSessions();
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('Failed to delete chat session');
            }
        }
        
        async function loadChatSessions() {
            try {
                const response = await fetch('/api/chat/sessions');
                if (!response.ok) throw new Error('Failed to load sessions');
                
                const data = await response.json();
                chatSessions = data.sessions || [];
                renderChatHistory();
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }
        
        function renderChatHistory() {
            const container = document.getElementById('chatHistoryList');
            const mobileContainer = document.getElementById('mobileChatHistoryList');
            
            const renderToContainer = (targetContainer) => {
                if (chatSessions.length === 0) {
                    targetContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No chat history</p>';
                    return;
                }
                
                targetContainer.innerHTML = chatSessions.map(session => {
                    const date = new Date(session.created_at);
                    const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const isActive = currentSessionId === session.id;
                    
                    return `
                        <div 
                            id="session-${session.id}" 
                            onclick="loadChatSession(${session.id})"
                            class="p-3 rounded-lg cursor-pointer transition-colors ${isActive ? 'bg-blue-100 dark:bg-blue-900/30' : 'hover:bg-gray-100 dark:hover:bg-gray-700'} group"
                        >
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${session.title || 'New Chat'}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${timeStr}</p>
                                </div>
                                <button 
                                    onclick="deleteChatSession(${session.id}, event)"
                                    class="ml-2 opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-opacity"
                                >
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            };
            
            renderToContainer(container);
            if (mobileContainer) {
                renderToContainer(mobileContainer);
            }
        }
        
        function updateActiveChat(sessionId) {
            // Update desktop sidebar
            document.querySelectorAll('#chatHistoryList > div').forEach(el => {
                el.classList.remove('bg-blue-100', 'dark:bg-blue-900/30');
                el.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            });
            
            // Update mobile sidebar
            const mobileContainer = document.getElementById('mobileChatHistoryList');
            if (mobileContainer) {
                mobileContainer.querySelectorAll('div').forEach(el => {
                    el.classList.remove('bg-blue-100', 'dark:bg-blue-900/30');
                    el.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                });
            }
            
            if (sessionId) {
                const activeEl = document.getElementById(`session-${sessionId}`);
                if (activeEl) {
                    activeEl.classList.add('bg-blue-100', 'dark:bg-blue-900/30');
                    activeEl.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                }
            }
        }
        
        // Message handling - Original function
        function addMessageOriginal(content, role, timestamp = new Date()) {
            const container = document.getElementById('messagesContainer');
            
            // Remove welcome message if exists
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (welcomeMsg) welcomeMsg.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} message-animate`;
            
            const timeStr = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-end space-x-2 max-w-3xl">
                        <div class="bg-blue-600 text-white rounded-2xl rounded-br-md px-4 py-2 shadow-sm">
                            <p class="text-sm whitespace-pre-wrap">${escapeHtml(content)}</p>
                            <p class="text-xs opacity-70 mt-1">${timeStr}</p>
                        </div>
                        {% if user.profile_pic %}
                        <img src="{{ user.profile_pic }}" alt="{{ user.name }}" class="w-8 h-8 rounded-full">
                        {% else %}
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm">
                            {{ user.name[0].upper() if user.name else 'U' }}
                        </div>
                        {% endif %}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-end space-x-2 max-w-3xl">
                        <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" alt="MediBot" class="w-8 h-8 rounded-full">
                        <div class="bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-2xl rounded-bl-md px-4 py-2 shadow-sm">
                            <p class="text-sm whitespace-pre-wrap">${escapeHtml(content)}</p>
                            <p class="text-xs opacity-70 mt-1">${timeStr}</p>
                        </div>
                    </div>
                `;
            }
            
            container.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Wrapped addMessage with TTS support
        function addMessage(content, role, timestamp = new Date()) {
            addMessageOriginal(content, role, timestamp);
            
            // Only speak assistant messages if TTS is enabled and we're not loading history
            if (role === 'assistant' && ttsEnabled && !isLoadingHistory) {
                // Wait a bit longer to ensure DOM is updated
                setTimeout(() => {
                    speakText(content);
                }, 300);
            }
        }
        
        function addLoadingMessage() {
            const container = document.getElementById('messagesContainer');
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (welcomeMsg) welcomeMsg.remove();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingMessage';
            loadingDiv.className = 'flex justify-start message-animate';
            loadingDiv.innerHTML = `
                <div class="flex items-end space-x-2 max-w-3xl">
                    <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" alt="MediBot" class="w-8 h-8 rounded-full">
                    <div class="bg-gray-200 dark:bg-gray-700 rounded-2xl rounded-bl-md px-4 py-3 shadow-sm">
                        <div class="flex space-x-2">
                            <div class="w-2 h-2 bg-gray-500 rounded-full loading-dot"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full loading-dot"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full loading-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
            scrollToBottom();
        }
        
        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) loadingMsg.remove();
        }
        
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Form handling - will be initialized in DOMContentLoaded
        function initFormHandlers() {
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
            
            if (!chatForm || !messageInput || !sendButton) return;
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            sendButton.disabled = !this.value.trim() || isLoading;
        });
        
        // Handle Enter key
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!isLoading && this.value.trim()) {
                    chatForm.dispatchEvent(new Event('submit'));
                }
            }
        });
        
        // Handle form submission
        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
                
                // Stop any ongoing speech when user sends a message
                if (currentUtterance) {
                    window.speechSynthesis.cancel();
                    currentUtterance = null;
                }
            
            const message = messageInput.value.trim();
            if (!message || isLoading) return;
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendButton.disabled = true;
            isLoading = true;
            
            // Add user message
            addMessage(message, 'user');
            
            // Add loading message
            addLoadingMessage();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        msg: message,
                        session_id: currentSessionId
                    })
                });
                
                if (!response.ok) throw new Error('Failed to get response');
                
                const data = await response.json();
                
                // Remove loading message
                removeLoadingMessage();
                
                // Add assistant message
                addMessage(data.response, 'assistant');
                
                // Update session ID if it's a new session
                if (data.session_id && !currentSessionId) {
                    currentSessionId = data.session_id;
                    await loadChatSessions();
                    updateActiveChat(currentSessionId);
                }
                
            } catch (error) {
                console.error('Error:', error);
                removeLoadingMessage();
                addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            } finally {
                isLoading = false;
                messageInput.focus();
            }
        });
        }
        
        // Text-to-Speech functionality
        function speakText(text) {
            console.log('speakText called:', { ttsEnabled, text: text ? text.substring(0, 50) + '...' : 'empty' });
            
            if (!ttsEnabled) {
                console.log('TTS is disabled');
                return;
            }
            
            if (!text || text.trim() === '') {
                console.log('No text to speak');
                return;
            }
            
            // Stop any ongoing speech
            if (currentUtterance) {
                window.speechSynthesis.cancel();
            }
            
            // Animate doctor avatar to speaking state
            const doctorAvatar = document.getElementById('doctorAvatar');
            if (doctorAvatar) {
                try {
                    if (doctorAvatar.setSpeed) {
                        doctorAvatar.setSpeed(1.5);
                    }
                    if (doctorAvatar.play) {
                        doctorAvatar.play();
                    }
                } catch (e) {
                    console.log('Could not control avatar animation:', e);
                }
            }
            
            // Check if speech synthesis is available
            if (!('speechSynthesis' in window)) {
                console.warn('Speech Synthesis API not supported');
                return;
            }
            
            // Create new utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            utterance.lang = 'en-US';
            
            utterance.onstart = function() {
                console.log('Speech started');
                // Ensure animation is playing
                if (doctorAvatar) {
                    try {
                        if (doctorAvatar.play) {
                            doctorAvatar.play();
                        }
                        if (doctorAvatar.setSpeed) {
                            doctorAvatar.setSpeed(1.5);
                        }
                    } catch (e) {
                        console.log('Error controlling avatar:', e);
                    }
                }
            };
            
            utterance.onend = function() {
                console.log('Speech ended');
                currentUtterance = null;
                // Return to normal animation speed
                if (doctorAvatar) {
                    try {
                        if (doctorAvatar.setSpeed) {
                            doctorAvatar.setSpeed(1);
                        }
                    } catch (e) {
                        console.log('Error resetting avatar speed:', e);
                    }
                }
            };
            
            utterance.onerror = function(event) {
                console.error('Speech synthesis error:', event.error);
                currentUtterance = null;
                // Return to normal animation speed on error
                if (doctorAvatar) {
                    try {
                        if (doctorAvatar.setSpeed) {
                            doctorAvatar.setSpeed(1);
                        }
                    } catch (e) {
                        console.log('Error resetting avatar on error:', e);
                    }
                }
            };
            
            currentUtterance = utterance;
            
            try {
                window.speechSynthesis.speak(utterance);
                console.log('Speech synthesis started');
            } catch (e) {
                console.error('Error starting speech synthesis:', e);
            }
        }
        
        function startListening() {
            if (recognition && !isListening) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting speech recognition:', error);
                }
            }
        }
        
        function stopListening() {
            if (recognition && isListening) {
                isListening = false;
                const micButton = document.getElementById('micButton');
                const listeningIndicator = document.getElementById('listeningIndicator');
                const micIcon = document.getElementById('micIcon');
                if (micButton) micButton.classList.remove('hidden');
                if (listeningIndicator) listeningIndicator.classList.add('hidden');
                if (micIcon) {
                    micIcon.classList.remove('fa-microphone-slash');
                    micIcon.classList.add('fa-microphone');
                }
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('Error stopping speech recognition:', error);
                }
            }
        }
        
        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const chatForm = document.getElementById('chatForm');
            const micButton = document.getElementById('micButton');
            const ttsToggle = document.getElementById('ttsToggle');
            
            // Initialize Speech Recognition if available
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition && micButton) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    isListening = true;
                    if (micButton) micButton.classList.add('hidden');
                    const listeningIndicator = document.getElementById('listeningIndicator');
                    if (listeningIndicator) listeningIndicator.classList.remove('hidden');
                    const micIcon = document.getElementById('micIcon');
                    if (micIcon) {
                        micIcon.classList.remove('fa-microphone');
                        micIcon.classList.add('fa-microphone-slash');
                    }
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    if (messageInput) {
                        messageInput.value = transcript;
                        messageInput.style.height = 'auto';
                        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
                    }
                    if (sendButton) sendButton.disabled = !transcript.trim() || isLoading;
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopListening();
                    if (event.error === 'no-speech') {
                        alert('No speech detected. Please try again.');
                    } else if (event.error === 'not-allowed') {
                        alert('Microphone access denied. Please enable microphone permissions.');
                    }
                };
                
                recognition.onend = function() {
                    stopListening();
                };
                
                // Microphone button click handler
                micButton.addEventListener('click', function() {
                    if (isListening) {
                        stopListening();
                    } else {
                        startListening();
                    }
                });
            } else {
                // Hide microphone button if Speech Recognition is not supported
                if (micButton) micButton.style.display = 'none';
                console.warn('Speech Recognition API not supported in this browser');
            }
            
            // Load TTS preference from localStorage
            const savedTtsEnabled = localStorage.getItem('ttsEnabled');
            if (savedTtsEnabled !== null) {
                ttsEnabled = savedTtsEnabled === 'true';
            }
            
            // Update TTS toggle button state
            if (ttsToggle) {
                const icon = document.getElementById('ttsIcon');
                if (ttsEnabled) {
                    if (icon) {
                        icon.classList.remove('fa-volume-mute');
                        icon.classList.add('fa-volume-up');
                    }
                    ttsToggle.title = 'Disable Text-to-Speech';
                } else {
                    if (icon) {
                        icon.classList.remove('fa-volume-up');
                        icon.classList.add('fa-volume-mute');
                    }
                    ttsToggle.title = 'Enable Text-to-Speech';
                }
                
                // TTS Toggle button handler
                ttsToggle.addEventListener('click', function() {
                    ttsEnabled = !ttsEnabled;
                    const icon = document.getElementById('ttsIcon');
                    
                    if (ttsEnabled) {
                        if (icon) {
                            icon.classList.remove('fa-volume-mute');
                            icon.classList.add('fa-volume-up');
                        }
                        this.title = 'Disable Text-to-Speech';
                    } else {
                        if (icon) {
                            icon.classList.remove('fa-volume-up');
                            icon.classList.add('fa-volume-mute');
                        }
                        this.title = 'Enable Text-to-Speech';
                        // Stop any ongoing speech
                        if (currentUtterance) {
                            window.speechSynthesis.cancel();
                            currentUtterance = null;
                        }
                    }
                    
                    // Save preference to localStorage
                    localStorage.setItem('ttsEnabled', ttsEnabled);
                });
            }
            
            // Initialize form handlers (includes stopping speech on submit)
            initFormHandlers();
            
            // Initialize theme and chat history
        initTheme();
        renderChatHistory();
            if (messageInput) messageInput.focus();
            
            // Ensure theme is applied on load
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Also initialize theme immediately (before DOMContentLoaded)
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</body>
</html>
